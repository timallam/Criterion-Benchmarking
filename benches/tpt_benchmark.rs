extern crate num_cpus;
use criterion::{black_box, criterion_group, criterion_main, Criterion};

use criterion_bechmarking::{test_par_iter_impl, test_buildin_thread_impl, test_crossbeam_impl};

pub fn criterion_benchmark(c: &mut Criterion) {
    let raw_data = "9938483495893849584573546758222023923478378566312343548411
        8696789773741647185329732705036495911861322575564723963297542624962850
        8696789773741647185329732705036495911861322575564723963297542624962850
        1186132257556472396329754262496285070856234701860851907960690014725639
        9568567925467788898949402957676739330045453483812828576576362925957484
        1186132257556472396329754262496285070856234701860851907960690014725639
        7085623470186085190796069001472563938397966707106094172783238747669219
        3839796670710609417278323874766921970856234701860851907960690014725639
        5590035677894520000467456774766921970856234701860851907960690014725639
        3839796670710609417278323874766921938397966707106094172783238747669219
        3839796670710609417278323874766921938397966707106094172783238747669219
        3839796670710609417278323874766921952380795257888236525459303330302837
        3839796670743587435891094587290146752380795257888236525459303330302837
        8283848948294756565649493737473562478611715465628562756275662826828658
        5849532713574404104889788573429781269920216438980873548808413720956532
        5849532713574404104889788573429781269920216438980873548808413720956532
        1627842463745258986034537482857466844556757634534878932565675673228954";

    let cpu_number = num_cpus::get();

    let raw_data_as_str = raw_data
        .split_whitespace()
        .map(|chunk| chunk.trim().to_string())
        .collect::<String>();

    let data_segments = raw_data_as_str
        .as_bytes()
        .chunks(raw_data_as_str.len() / cpu_number)
        .map(|s| unsafe { ::std::str::from_utf8_unchecked(s)})
        .collect::<Vec<&str>>();

    c.bench_function(
        "buildin",   
        |b| b.iter(|| { 
            test_buildin_thread_impl(black_box(&data_segments))
        })
    );

    c.bench_function(
        "crossbeam", 
        |b| b.iter(|| {
            test_crossbeam_impl(black_box(&data_segments))
        })
    );

    c.bench_function(
        "par_iter",  
        |b| b.iter(|| {
            test_par_iter_impl(black_box(&data_segments))
        })
    );
}

criterion_group!(benches, criterion_benchmark);
criterion_main!(benches);
    
